{% extends 'base.html' %}
{% block body %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container mt-4">
    <h2 class="text-white mb-3">Find Raw Materials</h2>
    
    <form method="GET" action="{{ url_for('search') }}" class="mb-4 p-4 shadow rounded bg-light">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="q" class="form-label">Material Name</label>
                <input type="text" id="q" name="q" class="form-control" placeholder="Search by name" value="{{ request.args.get('q', '') }}">
            </div>
            <div class="col-md-4">
                <label for="category" class="form-label">Category</label>
                <select id="category" name="category" class="form-select">
                    <option value="">All Categories</option>
                    <option value="Metal" {% if request.args.get('category') == 'Metal' %}selected{% endif %}>Metal</option>
                    <option value="Plastic" {% if request.args.get('category') == 'Plastic' %}selected{% endif %}>Plastic</option>
                    <option value="Textile" {% if request.args.get('category') == 'Textile' %}selected{% endif %}>Textile</option>
                    <option value="Paper" {% if request.args.get('category') == 'Paper' %}selected{% endif %}>Paper</option>
                    <option value="Glass" {% if request.args.get('category') == 'Glass' %}selected{% endif %}>Glass</option>
                    <option value="Wood" {% if request.args.get('category') == 'Wood' %}selected{% endif %}>Wood</option>
                    <option value="Other" {% if request.args.get('category') == 'Other' %}selected{% endif %}>Other</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="condition" class="form-label">Condition</label>
                <select id="condition" name="condition" class="form-select">
                    <option value="">All Conditions</option>
                    <option value="New" {% if request.args.get('condition') == 'New' %}selected{% endif %}>New</option>
                    <option value="Used" {% if request.args.get('condition') == 'Used' %}selected{% endif %}>Used</option>
                    <option value="Recyclable" {% if request.args.get('condition') == 'Recyclable' %}selected{% endif %}>Recyclable</option>
                    <option value="Scrap" {% if request.args.get('condition') == 'Scrap' %}selected{% endif %}>Scrap</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-success mt-3 w-100">Search Nearby</button>
    </form>

    {% if searched %}
        <div id="map" style="height:500px; width:100%; border-radius: 15px; border: 3px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.3);"></div>
    {% else %}
        <div class="text-center p-5 rounded shadow-sm" style="background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);">
            <div class="py-4">
                <i class="fas fa-search-location mb-3" style="font-size: 3rem; color: #2D5A27;"></i>
                <h4 class="text-dark">Ready to find materials?</h4>
                <p class="text-muted">Enter search details above to see available resources on the map.</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
    {% if searched %}
        var map = L.map('map').setView([19.0760, 72.8777], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var materials = {{ materials|tojson|safe }};
        
        if (materials.length > 0) {
            var markerGroup = new L.featureGroup();
            materials.forEach(function(m) {
                if (m.latitude && m.longitude) {
                    var imgPath = m.image ? `/static/uploads/${m.image}` : '/static/images/default-material.jpg';
                    
                    var popupContent = `
                        <div style="display: flex; gap: 10px; min-width: 250px; align-items: center;">
                            <div style="flex: 1;">
                                <img src="${imgPath}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                            </div>
                            <div style="flex: 1.5;">
                                <h6 style="margin: 0;">${m.material_name}</h6>
                                <p style="font-size: 11px; margin: 0;">${m.category} | ${m.condition}</p>
                                <button class="btn btn-sm btn-success w-100 mt-2" onclick="sendRequest(${m.id})">Request</button>
                            </div>
                        </div>
                    `;
                    L.marker([m.latitude, m.longitude]).bindPopup(popupContent).addTo(markerGroup);
                }
            });
            markerGroup.addTo(map);
            map.fitBounds(markerGroup.getBounds(), {padding: [50, 50]}); 
        }

        function sendRequest(materialId) {
            fetch(`/send_request/${materialId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert(data.message || data.error);
            });
        }
    {% endif %}
</script>
{% endblock body %}